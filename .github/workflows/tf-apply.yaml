name: "Terraform Apply"

on: [workflow_dispatch]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  # https://docs.github.com/es/actions/learn-github-actions/environment-variables
  # https://docs.github.com/es/actions/learn-github-actions/contexts
  TF_STATE_NAME: ${{ github.ref }}
  FLUX_VERSION: "0.26.3"

jobs:
  terraform-apply:
    name: "Terraform apply"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Terraform
        env:
          TERRAFORM_VERSION: "0.13.0"
        run: |
          tf_version=$TERRAFORM_VERSION
          wget https://releases.hashicorp.com/terraform/"$tf_version"/terraform_"$tf_version"_linux_amd64.zip
          unzip terraform_"$tf_version"_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
      
      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          # Optional, GitHub token, a Personal Access Token with `public_repo` scope if needed
          # Required, if artifact is from a different repo
          # Required, if repo is private a Personal Access Token with `repo` scope is needed
          github_token: ${{secrets.GITHUB_TOKEN}}
          # Required, workflow file name or ID
          workflow: tf-plan.yaml
          # Optional, the status or conclusion of a completed workflow to search for
          # Can be one of a workflow conclusion:
          #   "failure", "success", "neutral", "cancelled", "skipped", "timed_out", "action_required"
          # Or a workflow status:
          #   "completed", "in_progress", "queued"
          workflow_conclusion: success
          # Optional, uploaded artifact name,
          # will download all artifacts if not specified
          # and extract them in respective subdirectories
          # https://github.com/actions/download-artifact#download-all-artifacts
          name: terraform-plan
          # Optional, directory where to extract artifact(s), defaults to current directory
          # path: extract_here
          
      - name: Terraform Apply
        run: |
          terraform init
          terraform apply -auto-approve -input=false terraform-plan-file
          terraform output -json
          terraform output -json > terraform-apply-output.json      
      
      - uses: actions/upload-artifact@v3
        with:
          name: terraform-apply-output
          path: |
            terraform-apply-output.json

      - name: Bootstrap FluxCD
        # borro instalacion kubectl, no se usa creo.
        run: |
          curl -s https://fluxcd.io/install.sh | bash
          flux -v
          